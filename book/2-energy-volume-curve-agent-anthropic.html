
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Energy Volume Curve Agent &#8212; LangSim</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'book/2-energy-volume-curve-agent-anthropic';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="Introduction.html">
  
  
  
  
  
  
    <p class="title logo__title">LangSim</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="Introduction.html">
                    LangSim
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Benchmark.html">Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="1-crystalstructure-agent.html">Crystalstructure Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="2-energy-volume-curve-agent.html">Energy Volume Curve Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="3-hackathon-demonstration.html">Hackathon Demonstration</a></li>
<li class="toctree-l1"><a class="reference internal" href="4-inverse-alloy-design.html">Inverse Alloy Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="Literature.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="Developer.html">For Developers</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/jan-janssen/langsim/master?urlpath=lab/tree/book/2-energy-volume-curve-agent-anthropic.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/book/2-energy-volume-curve-agent-anthropic.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Energy Volume Curve Agent</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-functions">Multiple Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#agents">Agents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#user-interactions">User Interactions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="energy-volume-curve-agent">
<h1>Energy Volume Curve Agent<a class="headerlink" href="#energy-volume-curve-agent" title="Link to this heading">#</a></h1>
<p>Based on the previous tutorial, the next step is to extend the simple crystal structure agent to address the benchmark challenge of calculating an energy-versus-volume curve using the EMT simulation code. Again, this demonstration is based on the Langchain tutorial for <a class="reference external" href="https://python.langchain.com/docs/how_to/custom_tools/">custom agents</a>.</p>
<p>As a first step, we import a number of python modules, these consist of the <a class="reference external" href="https://wiki.fysik.dtu.dk/ase/">ASE</a>, some standard python libraries as well as a number of tools from <a class="reference external" href="https://www.langchain.com">langchain</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ase.atoms</span><span class="w"> </span><span class="kn">import</span> <span class="n">Atoms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.build</span><span class="w"> </span><span class="kn">import</span> <span class="n">bulk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.calculators.emt</span><span class="w"> </span><span class="kn">import</span> <span class="n">EMT</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.constraints</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnitCellFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.eos</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_eos</span><span class="p">,</span> <span class="n">plot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ase.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">LBFGS</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">getpass</span><span class="w"> </span><span class="kn">import</span> <span class="n">getpass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">tool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentExecutor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents.format_scratchpad.openai_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_to_openai_tool_messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents.output_parsers.openai_tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIToolsAgentOutputParser</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.pydantic_v1</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">MessagesPlaceholder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>
</pre></div>
</div>
</div>
</div>
<section id="multiple-functions">
<h2>Multiple Functions<a class="headerlink" href="#multiple-functions" title="Link to this heading">#</a></h2>
<p>To connect multiple python functions, it is essential to convert all inputs and outputs to <code class="docutils literal notranslate"><span class="pre">JSON</span></code> compatible data types as the communication to the LLM in the background happens in terms of web requests using the <code class="docutils literal notranslate"><span class="pre">JSON</span></code> format. This especially applies to python functions which return python objects. In the case of <a class="reference external" href="https://wiki.fysik.dtu.dk/ase/">ASE</a> a typical python object is the <code class="docutils literal notranslate"><span class="pre">ase.atoms.Atoms()</span></code> object. To convert the <code class="docutils literal notranslate"><span class="pre">Atoms()</span></code> object to JSON format, we use a <a class="reference external" href="https://pydantic.dev">pydantic</a> data class as suggested by <a class="reference external" href="https://www.langchain.com">langchain</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AtomsDict</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
    <span class="n">cell</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>
    <span class="n">pbc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>

<span class="n">AtomsDict</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;title&#39;: &#39;AtomsDict&#39;,
 &#39;type&#39;: &#39;object&#39;,
 &#39;properties&#39;: {&#39;numbers&#39;: {&#39;title&#39;: &#39;Numbers&#39;,
   &#39;type&#39;: &#39;array&#39;,
   &#39;items&#39;: {&#39;type&#39;: &#39;integer&#39;}},
  &#39;positions&#39;: {&#39;title&#39;: &#39;Positions&#39;,
   &#39;type&#39;: &#39;array&#39;,
   &#39;items&#39;: {&#39;type&#39;: &#39;array&#39;, &#39;items&#39;: {&#39;type&#39;: &#39;number&#39;}}},
  &#39;cell&#39;: {&#39;title&#39;: &#39;Cell&#39;,
   &#39;type&#39;: &#39;array&#39;,
   &#39;items&#39;: {&#39;type&#39;: &#39;array&#39;, &#39;items&#39;: {&#39;type&#39;: &#39;number&#39;}}},
  &#39;pbc&#39;: {&#39;title&#39;: &#39;Pbc&#39;, &#39;type&#39;: &#39;array&#39;, &#39;items&#39;: {&#39;type&#39;: &#39;boolean&#39;}}},
 &#39;required&#39;: [&#39;numbers&#39;, &#39;positions&#39;, &#39;cell&#39;, &#39;pbc&#39;]}
</pre></div>
</div>
</div>
</div>
<p>In terms of functions, two functions are defined: A <code class="docutils literal notranslate"><span class="pre">get_equilibirum_lattice()</span></code> function which for a given chemical element returns the optimized equilibrium structure as <code class="docutils literal notranslate"><span class="pre">AtomsDict</span></code>. The second function is a <code class="docutils literal notranslate"><span class="pre">plot_equation_of_state()</span></code> function, which takes the already optimized structure as <code class="docutils literal notranslate"><span class="pre">AtomsDict</span></code> as input and then uses the <a class="reference external" href="https://wiki.fysik.dtu.dk/ase/">ASE</a> internal functionality to plot the energy volume curve.</p>
<p>The important point here is that <code class="docutils literal notranslate"><span class="pre">get_equilibirum_lattice()</span></code> would typically just return an <code class="docutils literal notranslate"><span class="pre">ase.atoms.Atoms()</span></code> object, but for compatibility with the LLM it has to be converted to an <code class="docutils literal notranslate"><span class="pre">AtomsDict</span></code> which can be converted to JSON. Finally, in the <code class="docutils literal notranslate"><span class="pre">plot_equation_of_state()</span></code> function the <code class="docutils literal notranslate"><span class="pre">AtomsDict</span></code> is again converted to an <code class="docutils literal notranslate"><span class="pre">ase.atoms.Atoms()</span></code> object to continue the calculation. This is currently a bit tedious.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@tool</span> 
<span class="k">def</span><span class="w"> </span><span class="nf">get_equilibirum_lattice</span><span class="p">(</span><span class="n">chemical_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AtomsDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns equilibrium atoms dictionary for a given chemical symbol&quot;&quot;&quot;</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">bulk</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">chemical_symbol</span><span class="p">)</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">EMT</span><span class="p">()</span>
    <span class="n">ase_optimizer_obj</span> <span class="o">=</span> <span class="n">LBFGS</span><span class="p">(</span><span class="n">UnitCellFilter</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span>
    <span class="n">ase_optimizer_obj</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fmax</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">AtomsDict</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">todict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_equation_of_state</span><span class="p">(</span><span class="n">atom_dict</span><span class="p">:</span> <span class="n">AtomsDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns plot of equation of state of chemical symbol for a given atoms dictionary&quot;&quot;&quot;</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">(</span><span class="o">**</span><span class="n">atom_dict</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
    <span class="n">atoms</span><span class="o">.</span><span class="n">calc</span> <span class="o">=</span> <span class="n">EMT</span><span class="p">()</span>
    <span class="n">eos</span> <span class="o">=</span> <span class="n">calculate_eos</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
    <span class="n">plotdata</span> <span class="o">=</span> <span class="n">eos</span><span class="o">.</span><span class="n">getplotdata</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">plotdata</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, the functions converted to LLM tools using the <code class="docutils literal notranslate"><span class="pre">tool</span></code> decorator can again be tested using the <code class="docutils literal notranslate"><span class="pre">invoke()</span></code> function. It takes a python dictionary as input to address the different arguments individually. With this test, the correct implementation of the python functions is validated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">el</span> <span class="o">=</span> <span class="s2">&quot;Al&quot;</span>
<span class="n">structure_dict</span> <span class="o">=</span> <span class="n">get_equilibirum_lattice</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;chemical_symbol&quot;</span><span class="p">:</span> <span class="n">el</span><span class="p">})</span>
<span class="n">plot_equation_of_state</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;atom_dict&quot;</span><span class="p">:</span> <span class="n">structure_dict</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>       Step     Time          Energy          fmax
LBFGS:    0 07:48:58       -0.001502        0.161794
LBFGS:    1 07:48:58       -0.002533        0.135471
LBFGS:    2 07:48:58       -0.004879        0.005452
LBFGS:    3 07:48:58       -0.004883        0.000157
LBFGS:    4 07:48:58       -0.004883        0.000000
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/9p/rztyv06d0xv4h26cyv8nrw3m0000gq/T/ipykernel_2250/2598102435.py:6: FutureWarning: Import UnitCellFilter from ase.filters
  ase_optimizer_obj = LBFGS(UnitCellFilter(atoms))
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: title={&#39;center&#39;: &#39;sj: E: -0.005 eV, V: 15.932 Å$^3$, B: 39.519 GPa&#39;}, xlabel=&#39;volume [Å$^3$]&#39;, ylabel=&#39;energy [eV]&#39;&gt;
</pre></div>
</div>
<img alt="../_images/3ddd53a02a23322f9960c2709396e867f7a13d109c100c022de9d0aecdb16bec.png" src="../_images/3ddd53a02a23322f9960c2709396e867f7a13d109c100c022de9d0aecdb16bec.png" />
</div>
</div>
</section>
<section id="agents">
<h2>Agents<a class="headerlink" href="#agents" title="Link to this heading">#</a></h2>
<p>Following the same Langchain tutorial for <a class="reference external" href="https://python.langchain.com/docs/how_to/custom_tools/">custom agents</a> as before a LLM agent is constructed which combines the system prompt, the python functions <code class="docutils literal notranslate"><span class="pre">get_equilibirum_lattice()</span></code> and <code class="docutils literal notranslate"><span class="pre">plot_equation_of_state()</span></code> as tools and the <code class="docutils literal notranslate"><span class="pre">OpenAIToolsAgentOutputParser()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ANTHROPIC_API_KEY</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="s1">&#39;Enter your Anthropic Token:&#39;</span><span class="p">)</span>
<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-5-sonnet-20240620&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">anthropic_api_key</span><span class="o">=</span><span class="n">ANTHROPIC_API_KEY</span><span class="p">,)</span>
<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_equilibirum_lattice</span><span class="p">,</span> <span class="n">plot_equation_of_state</span><span class="p">]</span>
<span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;system&quot;</span><span class="p">,</span>
            <span class="s2">&quot;You are very powerful assistant, but don&#39;t know current events. For each query vailidate that it contains a chemical element and otherwise cancel.&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{input}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">MessagesPlaceholder</span><span class="p">(</span><span class="n">variable_name</span><span class="o">=</span><span class="s2">&quot;agent_scratchpad&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">agent</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">],</span>
        <span class="s2">&quot;agent_scratchpad&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">format_to_openai_tool_messages</span><span class="p">(</span>
            <span class="n">x</span><span class="p">[</span><span class="s2">&quot;intermediate_steps&quot;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">}</span>
    <span class="o">|</span> <span class="n">prompt</span>
    <span class="o">|</span> <span class="n">llm</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">OpenAIToolsAgentOutputParser</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">agent_executor</span> <span class="o">=</span> <span class="n">AgentExecutor</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
<section id="user-interactions">
<h2>User Interactions<a class="headerlink" href="#user-interactions" title="Link to this heading">#</a></h2>
<p>The user can then interact with the agent by asking it to <code class="docutils literal notranslate"><span class="pre">Plot</span> <span class="pre">the</span> <span class="pre">equation</span> <span class="pre">of</span> <span class="pre">state</span> <span class="pre">of</span> <span class="pre">gold</span></code>. In the background the agent first calls the <code class="docutils literal notranslate"><span class="pre">get_equilibirum_lattice()</span></code> with the parameter <code class="docutils literal notranslate"><span class="pre">Au</span></code> for the chemical symbol of gold and afterwards <code class="docutils literal notranslate"><span class="pre">plot_equation_of_state()</span></code> with the atomistic structure returned by <code class="docutils literal notranslate"><span class="pre">get_equilibirum_lattice()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent_executor</span><span class="o">.</span><span class="n">stream</span><span class="p">({</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="s2">&quot;Plot the equation of state of gold&quot;</span><span class="p">}))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">&gt; Entering new AgentExecutor chain...</span>

<span class=" -Color -Color-Bold -Color-Bold-Green">Invoking: `get_equilibirum_lattice` with `{&#39;chemical_symbol&#39;: &#39;Au&#39;}`</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">responded: [{&#39;text&#39;: &quot;Certainly! I&#39;d be happy to plot the equation of state for gold. To do this, we&#39;ll need to use two functions: first, we&#39;ll get the equilibrium lattice for gold, and then we&#39;ll use that to plot the equation of state.\n\nLet&#39;s start by getting the equilibrium lattice for gold:&quot;, &#39;type&#39;: &#39;text&#39;, &#39;index&#39;: 0}, {&#39;id&#39;: &#39;toolu_017dXVwAGh4D1LPEY24xDbZL&#39;, &#39;input&#39;: {}, &#39;name&#39;: &#39;get_equilibirum_lattice&#39;, &#39;type&#39;: &#39;tool_use&#39;, &#39;index&#39;: 1, &#39;partial_json&#39;: &#39;{&quot;chemical_symbol&quot;: &quot;Au&quot;}&#39;}]</span>

       Step     Time          Energy          fmax
LBFGS:    0 07:49:04        0.002606        0.308859
LBFGS:    1 07:49:04        0.000032        0.077808
LBFGS:    2 07:49:04       -0.000135        0.003099
LBFGS:    3 07:49:04       -0.000135        0.000029
LBFGS:    4 07:49:04       -0.000135        0.000000
<span class=" -Color -Color-Bold -Color-Bold-Cyan">numbers=[79] positions=[[4.761270571021482e-17, -3.44317321286765e-17, -2.0729599738876008e-16]] cell=[[7.040904860568557e-17, 2.028082809705617, 2.0280828097056176], [2.028082809705617, 1.0384771021574885e-16, 2.0280828097056176], [2.028082809705617, 2.028082809705618, 4.963320342464553e-17]] pbc=[True, True, True]</span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/9p/rztyv06d0xv4h26cyv8nrw3m0000gq/T/ipykernel_2250/2598102435.py:6: FutureWarning: Import UnitCellFilter from ase.filters
  ase_optimizer_obj = LBFGS(UnitCellFilter(atoms))
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
<span class=" -Color -Color-Bold -Color-Bold-Green">Invoking: `plot_equation_of_state` with `{&#39;atom_dict&#39;: {&#39;numbers&#39;: [79], &#39;positions&#39;: [[4.761270571021482e-17, -3.44317321286765e-17, -2.0729599738876008e-16]], &#39;cell&#39;: [[7.040904860568557e-17, 2.028082809705617, 2.0280828097056176], [2.028082809705617, 1.0384771021574885e-16, 2.0280828097056176], [2.028082809705617, 2.028082809705618, 4.963320342464553e-17]], &#39;pbc&#39;: [True, True, True]}}`</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">responded: [{&#39;text&#39;: &quot;\n\nGreat! Now that we have the equilibrium lattice for gold, let&#39;s use this information to plot the equation of state:&quot;, &#39;type&#39;: &#39;text&#39;, &#39;index&#39;: 0}, {&#39;id&#39;: &#39;toolu_01FAAFetx8gyYiSeE4v2siuj&#39;, &#39;input&#39;: {}, &#39;name&#39;: &#39;plot_equation_of_state&#39;, &#39;type&#39;: &#39;tool_use&#39;, &#39;index&#39;: 1, &#39;partial_json&#39;: &#39;{&quot;atom_dict&quot;: {&quot;numbers&quot;: [79], &quot;positions&quot;: [[4.761270571021482e-17, -3.44317321286765e-17, -2.0729599738876008e-16]], &quot;cell&quot;: [[7.040904860568557e-17, 2.028082809705617, 2.0280828097056176], [2.028082809705617, 1.0384771021574885e-16, 2.0280828097056176], [2.028082809705617, 2.028082809705618, 4.963320342464553e-17]], &quot;pbc&quot;: [true, true, true]}}&#39;}]</span>

<span class=" -Color -Color-Bold -Color-Bold-Yellow">Axes(0.125,0.11;0.775x0.77)</span><span class=" -Color -Color-Bold -Color-Bold-Green">[{&#39;text&#39;: &quot;\n\nThe equation of state for gold has been successfully plotted. The result is represented by an Axes object, which indicates that a graph has been generated.\n\nThis plot typically shows the relationship between the volume of the gold crystal and its energy. It helps in understanding the structural and thermodynamic properties of gold under different conditions.\n\nThe x-axis usually represents the volume (or sometimes the lattice constant), while the y-axis represents the total energy of the system. The minimum point on this curve corresponds to the equilibrium volume and energy of the gold crystal.\n\nIs there anything specific about the equation of state for gold that you&#39;d like to know or discuss further?&quot;, &#39;type&#39;: &#39;text&#39;, &#39;index&#39;: 0}]</span>

<span class=" -Color -Color-Bold">&gt; Finished chain.</span>
</pre></div>
</div>
<img alt="../_images/325e79b03ef4af2bae6e3ce1747b9e6242719a8c5f728a4ab5f044395add4b9f.png" src="../_images/325e79b03ef4af2bae6e3ce1747b9e6242719a8c5f728a4ab5f044395add4b9f.png" />
</div>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>The important point in this example is, that the order of execution of the Python functions is not defined by the user. Instead the LLM automatically determines that <code class="docutils literal notranslate"><span class="pre">plot_equation_of_state()</span></code> needs an <code class="docutils literal notranslate"><span class="pre">AtomsDict()</span></code> object as input and that <code class="docutils literal notranslate"><span class="pre">get_equilibirum_lattice()</span></code> returns such a <code class="docutils literal notranslate"><span class="pre">AtomsDict()</span></code> object as an output, so it makes sense to call <code class="docutils literal notranslate"><span class="pre">get_equilibirum_lattice()</span></code> first and <code class="docutils literal notranslate"><span class="pre">plot_equation_of_state()</span></code> second. The same principles apply to LLM agents with a larger number of python functions.</p>
<p>The limiting point at the moment is that the LLMs are web services, so all Python objects have to be converted to <code class="docutils literal notranslate"><span class="pre">JSON</span></code> to be communicated to the LLMs. This restricts the choice of Python objects and requires the development of specialized data classes to construct those interfaces between different Python functions.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./book"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#multiple-functions">Multiple Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#agents">Agents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#user-interactions">User Interactions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jan Janssen
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>